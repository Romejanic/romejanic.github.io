function loadAssets(a){callback=a,nextAssetToLoad=0,loader=document.createElement("div"),loadNextAsset()}function loadNextAsset(){if(nextAssetToLoad>=assetsToLoad.length)return void callback();var a=assetsToLoad[nextAssetToLoad];$(loader).load(a.path,function(){nextAssetToLoad++,assets.set(a.name,$(this).text()),loadNextAsset()})}function init(){viewportCtx=document.getElementById("viewportCanvas").getContext("2d"),initBackground=document.getElementById("background-img"),loadAssets(function(){assetsLoaded=!0,initWebGL()}),requestAnimationFrame(draw)}function draw(){resizeCanvas();var a=viewportCtx.canvas.width,b=viewportCtx.canvas.height;if((!webglInitialized||webglOpacity<1)&&viewportCtx.drawImage(initBackground,0,0,a,b),webglInitialized)gl.canvas.width=a,gl.canvas.height=b,viewportCtx.globalAlpha=webglOpacity,viewportCtx.drawImage(gl.canvas,0,0),viewportCtx.globalAlpha=1,webglOpacity=Math.min(webglOpacity+1/60,1);else if(webglError){var c=400,d=120,e=(a-c)/2,f=(b-d)/2;viewportCtx.fillStyle="red",viewportCtx.roundRect(e,f,c,d,15).fill(),viewportCtx.font="50px Arial",viewportCtx.fillStyle="white",viewportCtx.fillTextCentered("Error!",a/2,f+45),viewportCtx.font="15px Arial",viewportCtx.fillTextCentered("Error starting game!",a/2,b/2+20),viewportCtx.fillTextCentered(webglError,a/2,b/2+35)}else{var c=400,d=150,e=(a-c)/2,f=(b-d)/2;if(viewportCtx.fillStyle="green",viewportCtx.roundRect(e,f,c,d,15).fill(),viewportCtx.font="50px Arial",viewportCtx.fillStyle="white",viewportCtx.fillTextCentered("Loading",a/2,f+45),g)viewportCtx.font="15px Arial",viewportCtx.fillTextCentered("Starting game...",a/2,b/2+10);else{var g=Math.max(nextAssetToLoad,0),h=assetsToLoad.length;viewportCtx.font="15px Arial",viewportCtx.fillTextCentered("Loading assets: "+g+"/"+h,a/2,b/2+10);var i=Math.min(Math.max(g/h,0),1);viewportCtx.fillStyle="gray",viewportCtx.fillRect(e+10,b/2+30,c-20,20),viewportCtx.fillStyle="lime",viewportCtx.fillRect(e+10,b/2+30,(c-20)*i,20)}}requestAnimationFrame(draw)}function resizeCanvas(){viewportCtx.canvas.width=viewportCtx.canvas.offsetWidth,viewportCtx.canvas.height=viewportCtx.canvas.offsetHeight,viewportCtx.clearRect(0,0,viewportCtx.canvas.width,viewportCtx.canvas.height)}function VAO(a,b,c,d,e){this.gl=a,this.vao=b,this.elementCount=c,this.attribs=d,this.shader=e,this.overrideShader=!1}function VAOBuilder(a){this.gl=a,this.vao=a.createVertexArray(),this.elementCount=-1,this.attribs=new Array,this.shader=null,a.bindVertexArray(this.vao)}function Shader(a,b,c){this.gl=a,this.name=b,this.program=c,this.uniformCache=new Map}function initWebGL(){var a=document.createElement("canvas");if(gl=a.getContext("webgl2"),gl||(gl=a.getContext("experimental-webgl2"),console.warn("Core WebGL 2 not found! Falling back on experimental...")),!gl)return webglError="WebGL 2 not found or couldn't be initialised!",void console.error("ERROR: "+webglError);Shader.getShaderFile=function(a,b){var c=a+"."+b;return assets.has(c)?assets.get(c).trim():(console.error("Shader "+c+" not found!"),null)},initGL()}function initGL(){gl.clearColor(.4,.6,.9,1),gl.enable(gl.DEPTH_TEST),gl.enable(gl.CULL_FACE),gl.depthFunc(gl.LEQUAL),gl.cullFace(gl.BACK);var a=[-.5,-.5,0,.5,-.5,0,0,.5,0],b=[0,1,2];terrainVAO=new VAOBuilder(gl).addAttribute(0,3,a).addIndices(b).addShader("test").create(),requestAnimationFrame(render)}function render(){var a=gl.canvas.width,b=gl.canvas.height;calcMatrices(a,b),gl.viewport(0,0,a,b),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),terrainVAO.shader.bind(),terrainVAO.shader.setMat4("projMat",projMat),terrainVAO.shader.setMat4("viewMat",viewMat),terrainVAO.render(),requestAnimationFrame(render),webglInitialized||(webglInitialized=!0)}function calcMatrices(a,b){var c=a/b;mat4.ortho(projMat,-viewSize*c,viewSize*c,-viewSize,viewSize,-viewSize,viewSize),mat4.identity(viewMat),mat4.rotateX(viewMat,viewMat,glMatrix.toRadian(-30)),mat4.rotateY(viewMat,viewMat,glMatrix.toRadian(45)),mat4.translate(viewMat,viewMat,[0,-3,-5])}var assetsToLoad=[{name:"test.vs",path:"assets/shaders/test.vs",type:"shader"},{name:"test.fs",path:"assets/shaders/test.fs",type:"shader"}],nextAssetToLoad=-1,assets=new Map,loader,callback,viewportCtx,initBackground,assetsLoaded,webglOpacity=0,webglInitialized,webglError;window.onload=init,CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e){return c<2*e&&(e=c/2),d<2*e&&(e=d/2),this.beginPath(),this.moveTo(a+e,b),this.arcTo(a+c,b,a+c,b+d,e),this.arcTo(a+c,b+d,a,b+d,e),this.arcTo(a,b+d,a,b,e),this.arcTo(a,b,a+c,b,e),this.closePath(),this},CanvasRenderingContext2D.prototype.fillTextCentered=function(a,b,c){var d=this.measureText(a).width/2;this.fillText(a,b-d,c)},VAO.prototype.render=function(){var a=this.gl;this.overrideShader||this.shader.bind(),a.bindVertexArray(this.vao),this.attribs.forEach(function(b){a.enableVertexAttribArray(b)}),a.drawElements(a.TRIANGLES,this.elementCount,a.UNSIGNED_INT,0),this.attribs.forEach(function(b){a.disableVertexAttribArray(b)}),a.bindVertexArray(null),this.overrideShader||this.shader.unbind()},VAOBuilder.prototype.addAttribute=function(a,b,c){if(this.attribs.indexOf(a)>-1)return console.error("Attribute "+a+" already assigned!"),this;var d=this.gl,e=d.createBuffer();return d.bindBuffer(d.ARRAY_BUFFER,e),d.bufferData(d.ARRAY_BUFFER,new Float32Array(c),d.STATIC_DRAW),d.vertexAttribPointer(a,b,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,null),this.attribs.push(a),this},VAOBuilder.prototype.addIndices=function(a){if(this.elementCount>-1)return console.error("Indices already assigned!"),this;var b=this.gl,c=b.createBuffer();return b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c),b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint32Array(a),b.STATIC_DRAW),this.elementCount=a.length,this},VAOBuilder.prototype.addShader=function(a){return this.shader?void console.error("Shader program already assigned!"):(this.shader=Shader.loadShaderProgram(this.gl,a),this)},VAOBuilder.prototype.create=function(){return this.gl.bindVertexArray(null),this.vao?this.attribs.length<=0?(console.error("No attributes added!"),null):this.elementCount<0?(console.error("No indices added!"),null):this.shader?new VAO(this.gl,this.vao,this.elementCount,this.attribs,this.shader):(console.error("No shader program added!"),null):(console.error("Invalid VAO!"),null)},Shader.prototype.bind=function(){this.gl.useProgram(this.program)},Shader.prototype.unbind=function(){this.gl.useProgram(null)},Shader.prototype.getUniformLocation=function(a){if(this.uniformCache.has(a))return this.uniformCache.get(a);var b=this.gl.getUniformLocation(this.program,a);return this.uniformCache.set(a,b),b||console.warn("Uniform variable "+a+" not found in shader program "+this.name),b},Shader.prototype.setFloat=function(a,b){var c=this.getUniformLocation(a);c&&gl.uniform1f(c,b)},Shader.prototype.setInt=function(a,b){var c=this.getUniformLocation(a);c&&gl.uniform1i(c,b)},Shader.prototype.setMat4=function(a,b){var c=this.getUniformLocation(a);c&&gl.uniformMatrix4fv(c,!1,b)},Shader.prototype.setMat3=function(a,b){var c=this.getUniformLocation(a);c&&gl.uniformMatrix3fv(c,!1,b)},Shader.prototype.setMat2=function(a,b){var c=this.getUniformLocation(a);c&&gl.uniformMatrix2fv(c,!1,b)},Shader.prototype.setVec4=function(a,b){var c=this.getUniformLocation(a);c&&gl.uniform4fv(c,b)},Shader.prototype.setVec3=function(a,b){var c=this.getUniformLocation(a);c&&gl.uniform3fv(c,b)},Shader.prototype.setVec2=function(a,b){var c=this.getUniformLocation(a);c&&gl.uniform2fv(c,b)},Shader.loadShaderProgram=function(a,b){var c=a.createProgram(),d=Shader.loadShader(a,b,"vs",a.VERTEX_SHADER),e=Shader.loadShader(a,b,"fs",a.FRAGMENT_SHADER);if(a.attachShader(c,d),a.attachShader(c,e),a.linkProgram(c),!a.getProgramParameter(c,a.LINK_STATUS)){a.getProgramInfoLog(c);return a.deleteProgram(c),a.deleteShader(d),a.deleteShader(e),console.error("Program link failed!\n"+c),null}return a.detachShader(c,d),a.detachShader(c,e),a.deleteShader(d),a.deleteShader(e),new Shader(a,b,c)},Shader.loadShader=function(a,b,c,d){var e=a.createShader(d);if(a.shaderSource(e,Shader.getShaderFile(b,c)),a.compileShader(e),!a.getShaderParameter(e,a.COMPILE_STATUS)){var f=a.getShaderInfoLog(e);return a.deleteShader(e),console.error("Shader "+b+"_"+c+" failed to compile!\n"+f),null}return e},Shader.getShaderFile=function(a,b){var c=a+"_"+b,d=document.getElementById(c);return d?d.text.trim():(console.error("Shader script "+c+" not found! Create one in your header!"),null)};var gl,projMat=mat4.create(),viewMat=mat4.create(),viewSize=30,terrainVAO;